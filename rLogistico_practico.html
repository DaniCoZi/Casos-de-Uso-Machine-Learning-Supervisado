{% extends "base.html" %}
{% block content %}

<div class="container py-4 rl-page">

  <!-- FLASH -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- HEADER -->
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <div>
      <h1 class="page-title m-0">Regresión Logística</h1>
      <div class="text-muted small mt-1">
        Dataset del backend • Split 80/20 (estratificado) • LogisticRegression (L2) • Evaluación en test
      </div>
    </div>
    {% if accuracy is defined and accuracy is not none %}
      <span class="badge accuracy-badge">
        Accuracy <span class="val">{{ '%.4f'|format(accuracy) }}</span>
      </span>
    {% endif %}
  </div>

  <div class="text-muted small mb-3">
    Ruta en uso: <span class="csv-path">{{ csv_path }}</span>
  </div>

  <!-- EXPLICACIÓN: ¿Cómo funciona? -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
      <h5 class="card-title mb-2">¿Cómo funciona este ejercicio práctico?</h5>
      <ol class="small m-0">
        <li><b>Carga</b>: se utiliza el dataset del backend (<code>hotel_bookings.csv</code>).</li>
        <li><b>Split 80/20 con estratificación</b>: 80% para entrenamiento, 20% para test, preservando la proporción de clases.</li>
        <li><b>Entrenamiento</b>: modelo de <i>Regresión Logística</i> con regularización L2 por defecto.</li>
        <li><b>Evaluación</b>: sobre el conjunto de test se calcula <b>accuracy</b>, el <b>reporte de clasificación</b> y la <b>matriz de confusión</b>.</li>
        <li><b>Umbral (threshold)</b>: puedes mover el umbral para recalcular métricas y matriz <u>sin reentrenar</u> (se umbralizan las probabilidades).</li>
        <li><b>Predicción</b>: prueba un caso manual y obtén “Sí/No” + probabilidad asociada con el umbral actual.</li>
      </ol>
    </div>
  </div>

  <!-- ACCIONES -->
  <div class="card card-pane mb-4">
    <div class="card-body d-flex align-items-center gap-3 flex-wrap">
      <form method="post" action="{{ url_for('rLogistica_entrenar') }}">
        <button type="submit" class="btn btn-primary btn-action">
          Entrenar y evaluar
        </button>
      </form>

      <form class="d-flex align-items-center gap-2 ms-auto" action="{{ url_for('rLogistica_ajustar_umbral') }}" method="post">
        <label class="form-label m-0 small text-muted">Umbral</label>
        <input type="number" name="threshold" step="0.01" min="0" max="1"
              class="form-control form-control-sm input-th"
              value="{{ threshold if threshold is defined else 0.5 }}">
        <button class="btn btn-outline-secondary btn-sm" type="submit">Actualizar</button>
      </form>
    </div>
  </div>

  {% if report_html or cm_html %}
    <hr class="section-sep">
  {% endif %}

  <!-- REPORTE -->
  {% if report_html %}
  <section class="mb-4">
    <div class="section-head">
      <h2 class="h5 m-0">Reporte de clasificación</h2>
      <p class="small text-muted m-0">
        Por clase: <b>precision</b> (acierto cuando digo “Sí/No”), <b>recall</b> (detección de los reales),
        <b>f1</b> (media armónica) y <b>support</b> (casos en test).
      </p>
    </div>
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <div class="table-responsive nice-table">
          {{ report_html|safe }}
        </div>
        <div class="small text-muted mt-2">
          Filas finales: <i>accuracy</i> (global), <i>macro avg</i> (promedio simple),
          <i>weighted avg</i> (ponderado por soporte). Clases: <code>0 = No</code>, <code>1 = Sí</code>.
        </div>
      </div>
    </div>
  </section>
  {% endif %}

  <!-- MATRIZ -->
  {% if cm_html %}
  <section class="mb-5">
    <div class="section-head">
      <h2 class="h5 m-0">Matriz de confusión</h2>
      <p class="small text-muted m-0">
        Tabla 2×2 — Filas: <u>reales</u>, Columnas: <u>predichos</u>. Arriba-der: falsos positivos; abajo-izq: falsos negativos.
      </p>
    </div>
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <div class="row g-3 align-items-center">
          <div class="col-lg-5">
            <div class="table-responsive nice-table">
              {{ cm_html|safe }}
            </div>
            <div class="small text-muted mt-2">
              Cuadrante ideal: diagonal principal (clasificaciones correctas).
              Revisa el impacto del umbral en FP/FN según tu caso de uso.
            </div>
          </div>
          <div class="col-lg-7">
            <img src="{{ url_for('static', filename='confusion_logit.png') }}"
                 alt="Matriz de confusión (heatmap)"
                 class="img-fluid rounded shadow-sm border">
          </div>
        </div>
      </div>
    </div>
  </section>
  {% endif %}

  <!-- PREDICCIÓN RÁPIDA -->
  <section>
    <div class="section-head mb-2">
      <h2 class="h5 m-0">Predicción rápida</h2>
      <p class="small text-muted m-0">
        Ingresa un caso y obtén la probabilidad de <b>cancelación (Sí)</b>. Si la probabilidad ≥ <i>umbral</i>, la predicción será “Sí”, si no, “No”.
      </p>
    </div>

    <!-- EXPLICACIÓN: Predicción -->
    <div class="alert alert-secondary small shadow-sm mb-3">
      <b>¿Qué significa?</b>
      <ul class="m-0 ps-3">
        <li><b>Probabilidad</b>: salida del modelo (0–1) para la clase “Sí” (cancela).</li>
        <li><b>Umbral</b>: criterio de decisión. Con <code>0.50</code>, si prob ≥ 0.50 ⇒ “Sí”; si &lt; 0.50 ⇒ “No”.</li>
        <li><b>Interpretación</b>: “Sí” = la reserva se cancelaría; “No” = se mantendría.</li>
        <li><b>Tips</b>:
          <ul class="m-0 ps-3">
            <li>Para <i>minimizar falsos negativos</i> (no detectar una cancelación), usa un umbral <u>más bajo</u>.</li>
            <li>Para <i>minimizar falsos positivos</i> (marcar como cancelación cuando no lo es), usa un umbral <u>más alto</u>.</li>
          </ul>
        </li>
      </ul>
    </div>

    <div class="card shadow-sm border-0">
      <div class="card-body">
        <form method="post" action="{{ url_for('rLogistica_predecir') }}" class="row g-3">
          <div class="col-6 col-md-3">
            <label class="form-label">Días de antelación</label>
            <input type="number" class="form-control" name="dias_antelacion" value="60" required>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">Estancia previa</label>
            <input type="number" class="form-control" name="estancia_previa" value="2" required>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">Tamaño grupo</label>
            <input type="number" class="form-control" name="tamano_grupo" value="3" min="1" required>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">Tipo habitación</label>
            <select class="form-select" name="tipo_habitacion" required>
              <option value="Standard" selected>Standard</option>
              <option value="Deluxe">Deluxe</option>
              <option value="Suite">Suite</option>
            </select>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">Umbral</label>
            <input type="number" step="0.01" min="0" max="1"
                   class="form-control" name="threshold"
                   value="{{ threshold if threshold is defined else 0.5 }}">
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-success btn-action">Predecir</button>
          </div>
        </form>
      </div>
    </div>
  </section>

</div>

{% endblock %}
